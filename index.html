<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Union County Map ‚Äî Towns + Dots + Comments (Touch‚ÄëReady)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; margin: 0; }
    #app { height: 100%; display: grid; grid-template-rows: auto 1fr; }
    .topbar { display:flex; flex-wrap:wrap; gap:.5rem; align-items:center; padding:.6rem .8rem; border-bottom:1px solid #e5e7eb; background:#fff; position:sticky; top:0; z-index:10; }
    .topbar h1 { font:600 16px system-ui, -apple-system, Segoe UI, Roboto; margin:0 .5rem 0 0; }
    .btn { appearance:none; border:1px solid #e5e7eb; background:#fff; border-radius:12px; padding:.45rem .6rem; font:600 13px system-ui; cursor:pointer; }
    .btn:active{ transform:translateY(1px);} 
    .btn[data-active="true"]{ border-color:#111; box-shadow:0 0 0 2px rgba(0,0,0,.12);} 
    #map { height: 100%; width: 100%; }

    /* Dot visuals */
    .house-marker { position:relative; }
    .house { width: 14px; height: 14px; background:#fff; border:2px solid #6b7280; transform: rotate(45deg); border-radius:2px; box-sizing:border-box; }
    .status-green .house { border-color:#10b981; box-shadow:0 0 8px 2px rgba(16,185,129,.85);} 
    .status-red   .house { border-color:#ef4444; box-shadow:0 0 8px 2px rgba(239,68,68,.85);} 

    .legend { position:absolute; right:10px; bottom:12px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:.55rem .7rem; font:600 12px system-ui; display:grid; gap:.35rem; }
    .legend-row { display:flex; align-items:center; gap:.5rem; }
    .sq { width:12px; height:12px; transform: rotate(45deg); border:2px solid #6b7280; border-radius:2px; }
    .sq.g { border-color:#10b981; box-shadow:0 0 6px 1px rgba(16,185,129,.85);} 
    .sq.r { border-color:#ef4444; box-shadow:0 0 6px 1px rgba(239,68,68,.85);} 
    .badge { background:#111; color:#fff; padding:.1rem .4rem; border-radius:999px; font:700 11px system-ui; }
    .pill { background:#f3f4f6; padding:.15rem .45rem; border-radius:999px; font:600 11px system-ui; }

    .count-chip { background:#111827; color:#fff; font:700 11px system-ui; padding:2px 6px; border-radius:999px; border:1px solid #0b1220; }
    .block-label { background:rgba(255,255,255,.9); padding:2px 6px; border-radius:6px; border:1px solid #e5e7eb; font:700 11px system-ui; }
  </style>
</head>
<body>
  <div id="app">
    <div class="topbar">
      <h1>Union County, NJ</h1>
      <button id="baseStreetBtn" class="btn">Streets</button>
      <button id="baseSatBtn" class="btn">Satellite</button>
      <button id="baseHybridBtn" class="btn">Hybrid</button>
      <button id="toggleTownsBtn" class="btn" title="Show/Hide municipal boundaries">Hide Towns</button>
      <button id="addDotBtn" class="btn" aria-pressed="false" title="Tap the map to place dots">Add Dot</button>
      <button id="dotColorBtn" class="btn" aria-pressed="false" title="Toggle new dot color">Dot: Red</button>
      <button id="deleteDotBtn" class="btn" aria-pressed="false" title="Tap a dot to delete">Delete Dot</button>
      <button id="clearDotsBtn" class="btn" title="Remove all dots">Clear Dots</button>
      <span id="stats" class="pill">Ready</span>
      <span class="pill">Total Dots: <span id="dotTotal" class="badge">0</span></span>
      <button id="exportBtn" class="btn" title="Export dots to JSON">Export</button>
    </div>
    <div id="map" role="application" aria-label="Map with dots & towns"></div>
    <div class="legend">
      <div class="legend-row"><span class="sq g"></span> Green (visited)</div>
      <div class="legend-row"><span class="sq r"></span> Red (not visited)</div>
      <div class="legend-row">Dots: <span id="legendDotTotal" class="badge">0</span></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // =========================
    // Base map & basemap toggles
    // =========================
    const map = L.map('map', { tap: true }).setView([40.659, -74.304], 12);
    const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom:19, attribution:'¬© OpenStreetMap contributors' });
    const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { maxZoom: 19, attribution: 'Tiles ¬© Esri, Maxar' });
    const hybridLabels = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}.png', { subdomains:'abcd', maxZoom:20, attribution:'¬© OpenStreetMap, ¬© Carto' });
    streetLayer.addTo(map);

    const removeTileLayers = () => map.eachLayer(l => { if (l instanceof L.TileLayer) map.removeLayer(l); });
    document.getElementById('baseStreetBtn').addEventListener('click', ()=>{ removeTileLayers(); streetLayer.addTo(map); });
    document.getElementById('baseSatBtn').addEventListener('click', ()=>{ removeTileLayers(); satelliteLayer.addTo(map); });
    document.getElementById('baseHybridBtn').addEventListener('click', ()=>{ removeTileLayers(); satelliteLayer.addTo(map); hybridLabels.addTo(map); });

    const statsEl = document.getElementById('stats');
    const dotTotalEl = document.getElementById('dotTotal');
    const legendDotTotalEl = document.getElementById('legendDotTotal');

    // =========================
    // County boundary & Towns
    // =========================
    let unionBoundaryLayer = null;
    let townsVisible = false;
    const townLayer = L.layerGroup().addTo(map);

    (async function loadUnionCountyBoundary(){
      try {
        statsEl.textContent = 'Loading county‚Ä¶';
        const url = 'https://nominatim.openstreetmap.org/search?county=Union%20County&state=New%20Jersey&country=USA&format=geojson&polygon_geojson=1';
        const res = await fetch(url, { headers: { 'Accept': 'application/geo+json, application/json' }});
        const data = await res.json();
        const feat = data.features && data.features[0];
        if (!feat) throw new Error('County not found');
        unionBoundaryLayer = L.geoJSON(feat.geometry, { style: { color:'#111827', weight:2, fillOpacity:.05 }}).addTo(map);
        map.fitBounds(unionBoundaryLayer.getBounds().pad(0.1));
        statsEl.textContent = 'Ready';
        // Auto-load towns
        await toggleTowns();
      } catch (e) {
        console.warn(e);
        statsEl.textContent = 'County load failed';
      }
    })();

    async function toggleTowns(){
      const btn = document.getElementById('toggleTownsBtn');
      if (townsVisible) {
        townLayer.clearLayers();
        townsVisible=false;
        statsEl.textContent='Towns hidden';
        if (btn) btn.textContent = 'Show Towns';
        return;
      }
      statsEl.textContent = 'Loading towns‚Ä¶';
      townLayer.clearLayers();
      const q = `[
        out:json][timeout:180];
        area["name"="Union County"]["admin_level"="6"]["boundary"="administrative"]->.county;
        relation["boundary"="administrative"]["admin_level"="8"](area.county);
        out tags;
        >; out geom;`;
      try {
        const res = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body: q });
        const data = await res.json();
        const wayById = new Map();
        (data.elements||[]).forEach(el=>{ if(el.type==='way' && el.geometry){ wayById.set(el.id, el.geometry); }});
        const colors = ['#ef4444','#10b981','#3b82f6','#f59e0b','#8b5cf6','#06b6d4','#22c55e','#e11d48','#0ea5e9','#f97316'];
        let ci = 0;
        (data.elements||[]).forEach(el=>{
          if (el.type !== 'relation' || !el.tags || !el.tags.name) return;
          const name = el.tags.name;
          const color = colors[ci++ % colors.length];
          const outerWays = (el.members||[]).filter(m=>m.type==='way' && (m.role==='outer' || m.role===''));
          const polylines = [];
          outerWays.forEach(m=>{
            const geom = wayById.get(m.ref);
            if (!geom) return;
            const latlngs = geom.map(g=>[g.lat, g.lon]);
            polylines.push(latlngs);
          });
          if (polylines.length){
            polylines.forEach(lls=> L.polyline(lls, { color, weight: 2, opacity: 0.9 }).addTo(townLayer));
            const pts = polylines[0];
            const c = pts.reduce((a,p)=>[a[0]+p[0], a[1]+p[1]],[0,0]).map(v=>v/pts.length);
            L.marker([c[0], c[1]], { icon: L.divIcon({className:'', html:`<div class='block-label'>${name}</div>`}) }).addTo(townLayer);
          }
        });
        townsVisible = true;
        statsEl.textContent = 'Towns shown';
        if (btn) btn.textContent = 'Hide Towns';
      } catch (e) {
        console.warn('Towns load failed', e);
        statsEl.textContent = 'Towns load failed';
        if (btn) btn.textContent = 'Show Towns';
      }
    }
    document.getElementById('toggleTownsBtn').addEventListener('click', toggleTowns);

    // =========================
    // Dots (user-placed) + Comments
    // =========================
    const customDotLayer = L.layerGroup().addTo(map);
    const markerById = new Map();
    const customDots = []; // { id, lat, lng, status, seq, comment }
    let dotSeq = 0; // sequential counter for each dot

    function updateDotCounts(){
      const n = customDots.length;
      dotTotalEl.textContent = String(n);
      legendDotTotalEl.textContent = String(n);
    }

    function makeIcon(status='red') {
      return L.divIcon({ className: `house-marker status-${status}`, html: '<div class="house"></div>', iconSize:[14,14], iconAnchor:[7,7] });
    }

    function attachDotTooltip(marker, d){
      const content = `<span class='count-chip'>${d.seq}</span>${d.comment && d.comment.trim() ? ' üìù' : ''}`;
      marker.bindTooltip(content, { permanent:true, direction:'top', offset:[0,-14], opacity:1, className:'' });
    }
    function updateDotTooltip(marker, d){
      const content = `<span class='count-chip'>${d.seq}</span>${d.comment && d.comment.trim() ? ' üìù' : ''}`;
      const tt = marker.getTooltip();
      if (tt) tt.setContent(content); else marker.bindTooltip(content, { permanent:true, direction:'top', offset:[0,-14], opacity:1, className:'' });
    }

    function addCustomDot(d){
      if (typeof d.comment !== 'string') d.comment = '';
      const m = L.marker([d.lat, d.lng], { icon: makeIcon(d.status) }).addTo(customDotLayer);
      attachDotTooltip(m, d);
      m.bindPopup(() => {
        const safeComment = (d.comment || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `<div style=\"font:600 13px system-ui; display:grid; gap:.5rem; max-width:260px;\">\n          <div><strong>Dot #${d.seq}</strong><br><small>${d.id}</small></div>\n          <label style=\"font-weight:700; font-size:12px;\">Comment</label>\n          <textarea data-field=\"comment\" rows=\"3\" style=\"width:100%; font:600 12px system-ui; padding:.35rem; border:1px solid #e5e7eb; border-radius:8px;\">${safeComment}</textarea>\n          <div style=\"display:flex; gap:.4rem; align-items:center;\">\n            <button data-act=\"save-comment\">Save</button>\n            <span style=\"margin-left:auto; font-size:12px; opacity:.7;\">Set color:</span>\n            <button data-act=\"green\">Green</button>\n            <button data-act=\"red\">Red</button>\n            <button data-act=\"clear\">Clear</button>\n            <button data-act=\"delete\" style=\"margin-left:auto\">Delete</button>\n          </div>\n        </div>`;
      });
      m.on('popupopen', (e)=>{
        const root = e.popup.getElement();
        const ta = root.querySelector('textarea[data-field="comment"]');
        if (ta) ta.value = d.comment || '';
        root.querySelectorAll('[data-act]')?.forEach(btn=>{
          btn.addEventListener('click', ()=>{
            const act = btn.dataset.act;
            if (act === 'save-comment') {
              d.comment = (ta?.value || '').trim();
              updateDotTooltip(m, d);
              statsEl.textContent = d.comment ? 'Comment saved' : 'Comment cleared';
              m.closePopup();
              return;
            }
            if (act === 'delete') { removeDot(d.id); return; }
            d.status = (act==='clear') ? 'none' : act;
            m.setIcon(makeIcon(d.status));
            m.closePopup();
          }, { once:true });
        });
      });
      markerById.set(d.id, m);
      return m;
    }

    function removeDot(id){
      const idx = customDots.findIndex(x => x.id === id);
      if (idx !== -1) customDots.splice(idx,1);
      const m = markerById.get(id);
      if (m) { customDotLayer.removeLayer(m); markerById.delete(id); }
      updateDotCounts();
    }

    function clearAllDots(){
      customDots.splice(0, customDots.length);
      markerById.forEach(m => customDotLayer.removeLayer(m));
      markerById.clear();
      updateDotCounts();
    }

    // Modes
    let addDotMode = false;
    let deleteDotMode = false;
    let nextDotColor = 'red';

    const addDotBtn = document.getElementById('addDotBtn');
    const dotColorBtn = document.getElementById('dotColorBtn');
    const deleteDotBtn = document.getElementById('deleteDotBtn');
    const clearDotsBtn = document.getElementById('clearDotsBtn');

    addDotBtn.addEventListener('click', ()=>{
      addDotMode = !addDotMode; if (addDotMode) deleteDotMode = false; // mutually exclusive
      addDotBtn.dataset.active = String(addDotMode);
      addDotBtn.setAttribute('aria-pressed', String(addDotMode));
      deleteDotBtn.dataset.active = 'false';
      deleteDotBtn.setAttribute('aria-pressed','false');
      addDotBtn.textContent = addDotMode ? 'Add Dot: ON' : 'Add Dot';
    });

    dotColorBtn.addEventListener('click', ()=>{
      nextDotColor = (nextDotColor === 'red') ? 'green' : 'red';
      dotColorBtn.textContent = `Dot: ${nextDotColor.charAt(0).toUpperCase()+nextDotColor.slice(1)}`;
      dotColorBtn.setAttribute('aria-pressed', String(nextDotColor==='green'));
    });

    deleteDotBtn.addEventListener('click', ()=>{
      deleteDotMode = !deleteDotMode; if (deleteDotMode) addDotMode = false; // mutually exclusive
      deleteDotBtn.dataset.active = String(deleteDotMode);
      deleteDotBtn.setAttribute('aria-pressed', String(deleteDotMode));
      addDotBtn.dataset.active = 'false';
      addDotBtn.setAttribute('aria-pressed','false');
      addDotBtn.textContent = 'Add Dot';
      statsEl.textContent = deleteDotMode ? 'Delete mode: tap a dot to remove' : 'Ready';
    });

    clearDotsBtn.addEventListener('click', ()=>{ if (confirm('Clear all dots?')) clearAllDots(); });

    // Map interactions
    map.on('click', (e)=>{
      if (!addDotMode) return;
      const id = 'D-' + Math.random().toString(36).slice(2,7).toUpperCase();
      const d = { id, lat: e.latlng.lat, lng: e.latlng.lng, status: nextDotColor, seq: ++dotSeq, comment: '' };
      customDots.push(d);
      const m = addCustomDot(d);
      m.openPopup();
      updateDotCounts();
    });

    // Delegate click-to-delete when in delete mode
    customDotLayer.on('click', (e)=>{
      if (!deleteDotMode) return;
      const pair = Array.from(markerById.entries()).find(([id, m]) => m === e.layer || m._leaflet_id === e.layer._leaflet_id);
      if (pair) removeDot(pair[0]);
    });

    // Export dots as JSON (with comments)
    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const out = { dots: customDots.map(d => ({ id: d.id, lat: d.lat, lng: d.lng, status: d.status, seq: d.seq, comment: d.comment || '' })) };
      const blob = new Blob([JSON.stringify(out, null, 2)], { type:'application/json' });
      const url = URL.createObjectURL(blob);
      const a = Object.assign(document.createElement('a'), { href: url, download: 'union-dots.json' });
      a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 2000);
    });
  </script>
</body>
</html>
